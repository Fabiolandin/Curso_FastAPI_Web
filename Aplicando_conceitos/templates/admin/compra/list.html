{% extends 'admin/base.html' %}
{% block container %}
<h1 class="h3 mb-2 text-gray-800">Gerenciar Compras</h1>
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <div class="ms-3 d-inline-block">
            <a href="{{ url_for('compra_create')}}" class="btn btn-primary"> + Registrar Compra</a>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th class="w-1">Ações</th>
                        <th>ID</th>
                        <th>Fornecedor</th>
                        <th>Funcionário</th>
                        <th>Data</th>
                        <th>Valor Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% if dados %}
                    {% for dado in dados %}
                    <tr>
                        <td class="text-center">
                            <a href="{{ url_for('compra_details', compra_id=dado.id) }}" data-toggle="tooltip"
                                data-placement="top" title="Ver">
                                <span class="me-1 px-x">
                                    <i class="bi bi-eye"></i>
                                </span>
                            </a>
                            <a href="{{ url_for('compra_edit', compra_id=dado.id) }}" data-toggle="tooltip"
                                data-placement="top" title="Editar">
                                <span class="me-1 px-2">
                                    <i class="bi bi-pencil-square"></i>
                                </span>
                            </a>
                            <a href="{{ url_for('compra_delete', compra_id=dado.id) }}" class="btn-delete"
                                title="Deletar">
                                <span class="me-1 px-2">
                                    <i class="bi bi-trash"></i>
                                </span>
                            </a>
                        </td>
                        <td>{{ dado.id }}</td>
                        <td>{{ dado.fornecedor.nome }}</td>
                        <td>{{ dado.funcionario.nome }}</td>
                        <td>{{ dado.data_compra.strftime('%d/%m/%Y') }}</td>
                        <td>R$ {{ dado.valor_total|format_currency }}</td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="6">Nenhum registro encontrado</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% include 'admin/modals/delete.html' %}
{% endblock %}
<script>
document.querySelectorAll('.btn-delete').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
        e.preventDefault();
        if(confirm('Tem certeza que deseja deletar esta compra? O estoque NÃO será revertido automaticamente.')) {
            fetch(btn.getAttribute('href'), { method: 'DELETE' })
                .then(() => location.reload())
                .catch(err => alert('Erro ao deletar!'));
        }
    });
});
</script>